---
title: "Winter Olympics 2022 Figure Skating Predictions"
author: "Mehmed Can Olgac, B Lindsay, Mark Gjuraj"
date: "DUE: 2/7/2022"
output: html_document
---

## Data:

Outcomes of several events over the 2019-20, 2020-21, and 2021-22 seasons:

```{r}
d = read.csv('scores.csv', stringsAsFactors = FALSE)
str(d)
```

The 30 skaters competing in the 2022 Winter Olympics in Beijing:

```{r}
# SKATERS
s = read.csv('skaters2022.csv', stringsAsFactors = FALSE)
str(s)
```

The 13 judges (from 13 different countries) who will judge the short program, free skate, or both:

```{r}
# JUDGES
j = read.csv('judges2022.csv', stringsAsFactors = FALSE)
str(j)
```

```{r}
library(tidyverse)
d = d %>%
  mutate(score = ifelse(segment == 'short',
                        2 * score,
                        score)) %>%
  filter(judge != 'Mean')
```


## Additional Variable(s):

`same.country` is an indicator that is 1 when `country` and `jcountry` are the same, and 0 otherwise.

```{r}
d = d %>%
  mutate(same.country = ifelse(country == jcountry, 1, 0))
```

___

## Part 1: Regression Model for Segment Scores `score`:

```{r}
m1 = lm(score ~ segment + same.country + skater + judge, data=d)
summary(m1)$adj.r
```

```{r, eval = FALSE, include = FALSE}
## check the first few coefs
coefs = as.data.frame(summary(m1)$coef)
head(coefs,2)

## check that CHEN and HANYU are near or at the top
coefs %>% 
  as.data.frame() %>%
  arrange(desc(Estimate)) %>%
  head()
```

___

## Part 2: Make Predictions for all Skater-Judge Combinations:

```{r}
short <- expand_grid(s, j)
short$segment <- rep("short", 30*13)
head(short, 3)
```

```{r}
free <- expand_grid(s, j)
free$segment <- rep("free", 30*13)
head(free, 3)
```

```{r}
c <- bind_rows(short, free)
```

```{r}
c = c %>%
  mutate(same.country = ifelse(country == jcountry, 1, 0))
```

```{r}
c$predictions <- predict(m1, c)
head(arrange(c, desc(predictions)), 10)
```

___

## Part 3: Simulation

```{r}
judges <- unique(c$judge)
judges
skaters <- unique(c$skater)
skaters
```
*__Simulating the judge selection process:__*

The short program and free skate both have 9 judges that are selected in the following way.  

- **Short program judges.** Nine of these 13 judges are randomly selected for the short program.
- **Free skate judges.** The 4 judges that were not selected for the short program are automatically on the panel for the free skate. The remaining 5 judges are randomly chosen from the 9 who judged the short program. 

```{r}
short_judge <- sample(judges, 9, replace=FALSE)
short_judge
```

```{r}
not_short_judge <- setdiff(judges, short_judge)
not_short_judge
```

```{r}
free_judge_short <- sample(short_judge, 5)
free_judge <- c(not_short_judge, free_judge_short)
free_judge
```

*__Simulating the event:__*

```{r}
shortp <- c[c$judge %in% short_judge & c$segment == "short", ]
freep <- c[c$judge %in% free_judge & c$segment == "free", ]
```

```{r}
short_means <- aggregate(shortp$predictions, list(shortp$skater), FUN=mean)
short_means$x <- short_means$x
colnames(short_means) <- c("skater", "score")
short_means
```

```{r}
free_means <- aggregate(freep$predictions, list(freep$skater), FUN=mean)
colnames(free_means) <- c("skater", "score")
free_means
```

```{r}
std_dev <- 13
skater_sim <- c()
country_sim <- c()
segment_sim <- c()
score_sim <- c()
for (i in 1:30) {
  score_sim <- append(score_sim, 
                      rnorm(1, short_means$score[i], sd = std_dev) / 2)
  segment_sim <- append(segment_sim,
                        rep("short", 1))
  
  score_sim <- append(score_sim, 
                      rnorm(1, free_means$score[i], sd = std_dev))
  segment_sim <- append(segment_sim,
                        rep("free", 1))
  
  skater_sim <- append(skater_sim, 
                       rep(short_means$skater[i], 1 * 2))
  country_sim <- append(country_sim,
                        rep(s$country[s$skater==short_means$skater[i]], 1 * 2))
}
sims1 <- data.frame(skater_sim, country_sim, segment_sim, score_sim)
sims1
```

*__Repeat this process 10,000 times:__*

```{r}
nsim <- 10000
std_dev <- 13
skater_sim <- c()
country_sim <- c()
sim_num <- rep(c(1:nsim), 30 * 2)
segment_sim <- c()
score_sim <- c()

for (i in 1:30) {
  score_sim <- append(score_sim, 
                      rnorm(nsim, short_means$score[i], sd = std_dev) / 2)
  segment_sim <- append(segment_sim,
                        rep("short", nsim))
  
  score_sim <- append(score_sim, 
                      rnorm(nsim, free_means$score[i], sd = std_dev))
  segment_sim <- append(segment_sim,
                        rep("free", nsim))
  
  skater_sim <- append(skater_sim, 
                       rep(short_means$skater[i], nsim * 2))
  country_sim <- append(country_sim,
                        rep(s$country[s$skater==short_means$skater[i]], nsim * 2))
}

sims <- data.frame(skater_sim, country_sim, sim_num, segment_sim, score_sim)
colnames(sims) <- c("skater", "country", "sim", "segment", "score")
```

```{r}
head(sims[sims$skater == "Nathan CHEN", ])
tail(sims[sims$skater == "Nathan CHEN", ])
head(sims)
tail(sims)
```

___

## Part 4: Predictions

```{r}
ranks <- data.frame(matrix(data = rep(NA, nsim * 30), nrow = nsim, ncol = 30))
places <- c("p1", "p2", "p3", "p4", "p5", "p6", "p7",
            "p8", "p9", "p10", "p11", "p12", "p13",
            "p14", "p15", "p16", "p17", "p18", "p19",
            "p20", "p21", "p22", "p23", "p24", "p25",
            "p26", "p27", "p28", "p29", "p30")
colnames(ranks) <- places
for (i in 1:nsim) {
  temp1 <- sims[sims$sim == i, ]
  temp2 <- aggregate(temp1$score, list(temp1$skater), FUN=sum)
  ranking <- arrange(temp2, desc(x))$Group.1
  ranks[i, ] <- ranking
}
```

```{r}
ranks
```

```{r}
proportions <- data.frame(matrix(data = rep(0, 900), nrow = 30, ncol = 30))
rownames(proportions) <- unique(sims$skater)
colnames(proportions) <- places
```

```{r}
for (i in 1:30){
  temp <- table(ranks[[places[i]]]) / nsim
  for (name in names(temp)) {
    proportions[name, i] <- temp[name]
  }
}
```

```{r}
proportions
# https://stackoverflow.com/questions/29511215/convert-row-names-into-first-column
proportions <- tibble::rownames_to_column(proportions, "skater")
proportions
```

```{r}
scores_per_sim <- aggregate(sims$score, list(sims$skater, sims$sim), FUN = sum)
mean_scores <- aggregate(scores_per_sim$x, list(scores_per_sim$Group.1), FUN = mean)
mean_scores
sd_scores <- aggregate(scores_per_sim$x, list(scores_per_sim$Group.1), FUN = sd)
sd_scores
proportions$score <- mean_scores$x
proportions$sd <- sd_scores$x
pred <- proportions[, c(1, 32, 33, 2:31)]
pred
```






